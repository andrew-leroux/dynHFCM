<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="dynHFCM">
<title>Landmark Historical Functional Cox Regression • dynHFCM</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.11/clipboard.min.js" integrity="sha512-7O5pXpc0oCRrxk8RUfDYFgn0nO1t+jLuIOQdOMRp4APB7uZ4vSjspzp5y6YDtDs4VzUSTbWzBFZ/LKJhnyFOKw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Landmark Historical Functional Cox Regression">
<meta property="og:description" content="dynHFCM">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light" data-bs-theme="light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">dynHFCM</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/lm_hflm_estimation_prediction.html">Landmark Historical Functional Cox Regression</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Landmark Historical Functional Cox Regression</h1>
                        <h4 data-toc-skip class="author">Andrew
Leroux</h4>
            
            <h4 data-toc-skip class="date">2024-07-02</h4>
      
      
      <div class="d-none name"><code>lm_hflm_estimation_prediction.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>This document shows how to estimate the landmark historical
functional Cox regression model and extract estimated quantities of
interest. The vigentte is organized in three sections. In the first
section, we describe the model mathematically and provide details on the
method. In the next section, apply the method to simulated. In the final
section we show how to obtain estimated quantities of interest from the
fitted model. Note that this vignette is intended to be used in
conjunction with the manuscript entitled “Dynamic prediction using
landmark historical functional Cox regression” and a number of technical
details have been omitted here for brevity. Readers are encouraged to
read the manuscript prior to working through this vignette to better
understand the methodology involved.</p>
</div>
<div class="section level2">
<h2 id="the-landmark-historical-functional-cox-model-lm-hflm">The landmark historical functional Cox model (LM-HFLM)<a class="anchor" aria-label="anchor" href="#the-landmark-historical-functional-cox-model-lm-hflm"></a>
</h2>
<p>The landmark historical functional Cox model is a extension of the
Cox proportional hazards model for modeling time-to-event data (the
outcome) subject to right censoring in the presence of a time-varying
covariate. The model allows for the historical value of the time-varying
covariate to influence an individual’s risk in a way that varies over
the follow-up time. This association is modeled non-parametrically using
penalized regression splines.</p>
<p>The landmark approach to modelling time to event data is a
conditional approach whereby risk is modeled conditional on surviving up
to a set of landmark times through some follow-up period which may be
either short or long. Landmark models are a computationally efficient
approach to approximating a Cox model where time-varying covariates
and/or effects are present. In the case of the landmark historical
functional Cox model, the landmark approach is an approximation of the
historical functional Cox model. As a result, before describing the
LM-HFLCM we first introduce the historical functional Cox model as
motivation.</p>
<div class="section level3">
<h3 id="notation">Notation<a class="anchor" aria-label="anchor" href="#notation"></a>
</h3>
<p>Before we introduce the model we first define some necessary
notation. Let <span class="math inline">\(i = 1,\ldots,N\)</span> denote
individual. Let <span class="math inline">\(X_i\)</span> be a single
time invariant predictor, and let <span class="math inline">\(Z_{i}(t_{ij})\)</span> denote the <span class="math inline">\(j^{\text{th}}\)</span> observation of a single
time varying predictor at time <span class="math inline">\(t_{ij}\)</span>. We further introduce <span class="math inline">\(Z_i^{\mathcal{H}}(t) = \{Z_i(s): s \leq t
\}\)</span> to denote the history of <span class="math inline">\(Z(\cdot)\)</span> up to time <span class="math inline">\(t\)</span>. It is assumed that <span class="math inline">\(Z(\cdot)\)</span> is a continuous and bounded
stochastic process. <span class="math inline">\(Z(\cdot)\)</span> may be
observed at regular or irregular intervals and possibly with error.</p>
<p>Next, denote an individual’s true event time as <span class="math inline">\(T_i\)</span>, which is subject to right censoring,
denoted as <span class="math inline">\(C_i\)</span>. As a result of
censoring, we observe <span class="math inline">\(T_i^*=\min{(T_i,C_i)}\)</span>, and <span class="math inline">\(d_i = 1(T_i &lt; C_i)\)</span>, the event
indicator for subject <span class="math inline">\(i\)</span>. The
observed data are then <span class="math inline">\(\{T_i^*, d_i, X_i,
Z_i^{\mathcal{H}}(T_i^*): 1 \leq i \leq N\}\)</span>. Censoring time is
assumed to be independent of the event time given the covariates. For
the landmark approach we also require notation related to landmark
times. Specifically, we denote the collection of <span class="math inline">\(L\)</span> landmark times as <span class="math inline">\(\mathbf{s} = \{s_1, \ldots, s_L\}\)</span> and
<span class="math inline">\(L\)</span> corresponding prediction window
lengths <span class="math inline">\(\mathbf{w} = \{w_1, \ldots, w_L
\}\)</span>.</p>
</div>
<div class="section level3">
<h3 id="the-historical-functional-cox-model">The historical functional Cox model<a class="anchor" aria-label="anchor" href="#the-historical-functional-cox-model"></a>
</h3>
<p>The historical functional Cox model models the additive effect of
covariates on the log hazard function. Specifically, consider a time,
<span class="math inline">\(t\)</span>. The log hazard function for
subject <span class="math inline">\(i\)</span> is</p>
<p><span class="math display">\[\begin{equation}
\log \lambda_i(t|X_i, Z_i^{\mathcal{H}}(t)) = \log \lambda_0(t) +
X_i\mathbf{\beta} + \int_0^t Z_i(u)\gamma(u,t)du\;.
\end{equation}\]</span></p>
<p>In the model above, <span class="math inline">\(\gamma(\cdot,t)\)</span> is the historical effect
of the longitudinal predictor on experiencing the event. In trying to
interpret <span class="math inline">\(\gamma(\cdot,t)\)</span>, it can
be helpful to view it as a “weight” function which weights the relative
contribution of the entire history to the risk at the current time. For
example, if <span class="math inline">\(\gamma(u, t)\)</span> is large
and positive for values of <span class="math inline">\(u\)</span> close
to <span class="math inline">\(t\)</span> (recent history), and near
<span class="math inline">\(0\)</span> for values of <span class="math inline">\(u\)</span> far in the past, then higher
<em>recent</em> values of <span class="math inline">\(Z_i(u)\)</span>
are associated with an increased risk of event, while higher historical
values contribute little to the current risk.</p>
</div>
<div class="section level3">
<h3 id="the-landmark-historical-functional-cox-model-lm-hfcm">The landmark historical functional Cox model (LM-HFCM)<a class="anchor" aria-label="anchor" href="#the-landmark-historical-functional-cox-model-lm-hfcm"></a>
</h3>
<p>The problem with the historical functional Cox model in the context
of dynamic prediction can be seen by closer examination of the model.
Specifically, predictions of survival for some time <span class="math inline">\(t\)</span> given data up to time <span class="math inline">\(s &lt; t\)</span> require the time-dependent
covariate, <span class="math inline">\(Z_i(\cdot)\)</span>, all the way
up to time <span class="math inline">\(t\)</span>. However, <span class="math inline">\(Z_i(t)\)</span> is only partially observed,
specifically up to <span class="math inline">\(s\)</span>. A landmark
approach addresses this problem by using a set of landmark times <span class="math inline">\(\mathbf{s} = \{s_1, \ldots, s_L\}\)</span> and for
each landmark, <span class="math inline">\(s_l\)</span>, focusing on the
data for study participants who survived beyond <span class="math inline">\(s_l\)</span>. Combining the idea of the historical
functional Cox model with the landmark approach naturally leads to the
following landmark historical functional Cox model (LM-HFCM) <span class="math display">\[\begin{equation}
\log \lambda_i(t|X_i, Z_i^{\mathcal{H}}(s_l),s_l) = \log
\lambda_0(t|s_l) + X_i\mathbf{\beta}(s_l) +
\int_0^{s_l} Z_i(u)\gamma(u,s_l)du\;,
%\hspace{.5in} \mbox{for } s \leq t \leq  s + w_l .
\end{equation}\]</span> where <span class="math inline">\(s_l \leq t
\leq  s_l + w_l\)</span> are the landmark times for <span class="math inline">\(l = 1,\ldots, L\)</span>. A common appraoch is to
choose landmark times and prediction windows such that <span class="math inline">\((s_l, s_l + w_l]\)</span> forms a partition of
<span class="math inline">\((0, t_{\text{max}}]\)</span> with <span class="math inline">\(t_{\text{max}} = \text{max}(T_1^*, \ldots,
T_N^*)\)</span>.</p>
</div>
</div>
<div class="section level2">
<h2 id="lm-hfcm-estimation">LM-HFCM: Estimation<a class="anchor" aria-label="anchor" href="#lm-hfcm-estimation"></a>
</h2>
<p>Having introduced the method, we now how show how to estimate the
model using simulated data. We first load the data, set up the landmark
dataset, and then apply the method.</p>
<div class="section level3">
<h3 id="setting-up-the-data">Setting up the data<a class="anchor" aria-label="anchor" href="#setting-up-the-data"></a>
</h3>
<p>The data for this example have been simulated in advance the data
contained in this package. These data were simulated using the data
generating mechanism of scenario 2 in the manuscript. Code provided
below.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://andrew-leroux.github.io/dynHFCM/">dynHFCM</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"hfcm_sim_data"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">hfcm_sim_data</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## 'data.frame':    42619 obs. of  5 variables:</span></span>
<span><span class="co">##  $ id  : int  1 1 1 1 1 1 1 1 1 1 ...</span></span>
<span><span class="co">##  $ T   : num  0.319 0.319 0.319 0.319 0.319 ...</span></span>
<span><span class="co">##  $ E   : num  1 1 1 1 1 1 1 1 1 1 ...</span></span>
<span><span class="co">##  $ Z   : num  0.957 -0.104 -0.678 -1.012 -1.956 ...</span></span>
<span><span class="co">##  $ tind: num  0 0.01 0.02 0.03 0.04 0.05 0.06 0.07 0.08 0.09 ...</span></span></code></pre>
<p>The data are provided in long format, with a column for subject
identifier (id), event/censoring time (T, <span class="math inline">\(T_i^*\)</span>), event indicator (E, <span class="math inline">\(d_i\)</span>), the longitudinal predictor (Z,
<span class="math inline">\(Z_i(t)\)</span>) and the time of observation
for <span class="math inline">\(Z_i\)</span> (tind, <span class="math inline">\(t\)</span>).</p>
<p>Once we’ve loaded the data, the next step is to create the landmark
dataset. The code below shows how to create the landmark dataset
required for model fitting using the <strong>make_lm_data</strong>
function from the <em>dynHFCM</em> package. Here, we fit two LM-HFCM
models which use the same set of landmark times (<span class="math inline">\(\mathbf{s}\)</span>) with two different choices
for prediction windows <span class="math inline">\(w = 0.02\)</span> and
<span class="math inline">\(w=\infty\)</span>. Landmark times are chosen
to be an evenly spaced grid of length 50 on <span class="math inline">\([0,1)\)</span>. In this way the first set of
landmark times/prediction windows forms a partition of the range of the
event time (all participants data are administratively censored at <span class="math inline">\(t=1\)</span>), while the second set of landmark
times/prediction windows uses overlapping times.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## grid of observation</span></span>
<span><span class="va">tmin</span> <span class="op">&lt;-</span> <span class="fl">0</span> <span class="co"># time of first observation</span></span>
<span><span class="va">tmax</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="co"># time of last observation (administrative censoring)</span></span>
<span></span>
<span><span class="co">## landmark times and prediciton windows</span></span>
<span><span class="va">S</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="va">tmin</span>, <span class="va">tmax</span>, len<span class="op">=</span><span class="fl">51</span><span class="op">)</span><span class="op">[</span><span class="op">-</span><span class="fl">51</span><span class="op">]</span>       <span class="co"># landmark times for both landmark models</span></span>
<span><span class="va">W1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/diff.html" class="external-link">diff</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">S</span>, <span class="va">tmax</span><span class="op">)</span><span class="op">)</span>                  <span class="co"># prediction windows for first landmark model (w=0.04)</span></span>
<span><span class="va">W2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="cn">Inf</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">S</span><span class="op">)</span><span class="op">)</span>               <span class="co"># prediction windows for second landmark model (w=infinity)</span></span>
<span></span>
<span></span>
<span><span class="co">## create landmark datasets for estiamting the landmark historical functional Cox models</span></span>
<span><span class="va">data_lm_w1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/make_lm_data.html">make_lm_data</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">hfcm_sim_data</span>, vars_tv<span class="op">=</span><span class="st">"Z"</span>,vars_tf<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span>, id<span class="op">=</span><span class="st">"id"</span>, event_time<span class="op">=</span><span class="st">"T"</span>, </span>
<span>                           time<span class="op">=</span><span class="st">"tind"</span>, S<span class="op">=</span><span class="va">S</span>, wide<span class="op">=</span><span class="cn">FALSE</span>, censor_var<span class="op">=</span><span class="st">"E"</span>, w<span class="op">=</span><span class="va">W1</span><span class="op">)</span></span>
<span><span class="va">data_lm_w2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/make_lm_data.html">make_lm_data</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">hfcm_sim_data</span>, vars_tv<span class="op">=</span><span class="st">"Z"</span>,vars_tf<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span>, id<span class="op">=</span><span class="st">"id"</span>, event_time<span class="op">=</span><span class="st">"T"</span>, </span>
<span>                           time<span class="op">=</span><span class="st">"tind"</span>, S<span class="op">=</span><span class="va">S</span>, wide<span class="op">=</span><span class="cn">FALSE</span>, censor_var<span class="op">=</span><span class="st">"E"</span>, w<span class="op">=</span><span class="va">W2</span><span class="op">)</span></span></code></pre></div>
<p>We show the structure of the landmark data below. The data are
organized by participant (id). From the original data file we know that
participant 1 experienced the event at <span class="math inline">\(T_i =
0.319\)</span>. So, this participant will have data for each for the
first 16 landmark times. The new landmark dataset has additional columns
for the landmark time (s, <span class="math inline">\(s\)</span>), the
corresponding prediction window (w_s, <span class="math inline">\(w_s\)</span>), the landmark-specific event time
(event_time_lm), and the landmark specific event indicator. Because
individual id=1 has event beyond the prediction window of <span class="math inline">\(w=0.02\)</span> for the first several landmark
times, their landmark-specific event indicator is <span class="math inline">\(0\)</span> and event time equal to <span class="math inline">\(s_l + w = s_l + 0.02\)</span>.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">data_lm_w1</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## 'data.frame':    21543 obs. of  11 variables:</span></span>
<span><span class="co">##  $ id           : Factor w/ 1000 levels "1","2","3","4",..: 1 1 1 1 1 1 1 1 1 1 ...</span></span>
<span><span class="co">##  $ T            : num  0.319 0.319 0.319 0.319 0.319 ...</span></span>
<span><span class="co">##  $ E            : num  1 1 1 1 1 1 1 1 1 1 ...</span></span>
<span><span class="co">##  $ s            : num  0 0.02 0.04 0.06 0.08 0.1 0.12 0.14 0.16 0.18 ...</span></span>
<span><span class="co">##  $ w_s          : num  0.02 0.02 0.02 0.02 0.02 0.02 0.02 0.02 0.02 0.02 ...</span></span>
<span><span class="co">##  $ event_time_lm: num  0.02 0.04 0.06 0.08 0.1 0.12 0.14 0.16 0.18 0.2 ...</span></span>
<span><span class="co">##  $ event_lm     : num  0 0 0 0 0 0 0 0 0 0 ...</span></span>
<span><span class="co">##  $ tind         : 'AsIs' num [1:21543, 1:99] 0 0 0 0 0 0 0 0 0 0 ...</span></span>
<span><span class="co">##   ..- attr(*, "dimnames")=List of 2</span></span>
<span><span class="co">##   .. ..$ : chr [1:21543] "1" "1" "1" "1" ...</span></span>
<span><span class="co">##   .. ..$ : chr [1:99] "1" "2" "3" "4" ...</span></span>
<span><span class="co">##  $ Z            : 'AsIs' num [1:21543, 1:99] 0.957 0.957 0.957 0.957 0.957 ...</span></span>
<span><span class="co">##   ..- attr(*, "dimnames")=List of 2</span></span>
<span><span class="co">##   .. ..$ : chr [1:21543] "1" "1" "1" "1" ...</span></span>
<span><span class="co">##   .. ..$ : chr [1:99] "1" "2" "3" "4" ...</span></span>
<span><span class="co">##  $ smat         : 'AsIs' num [1:21543, 1:99] 0 0.02 0.04 0.06 0.08 0.1 0.12 0.14 0.16 0.18 ...</span></span>
<span><span class="co">##  $ Z_int_cn     : 'AsIs' num [1:21543, 1:99] 0.00928 0.00941 0.00949 0.00972 0.0098 ...</span></span></code></pre>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">data_lm_w1</span><span class="op">$</span><span class="va">id</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 16</span></span></code></pre>
<p>If we now view the second landmark dataset, with <span class="math inline">\(w=\infty\)</span>, we see that individual id=1 has
landmark-specific event indicators of <span class="math inline">\(1\)</span> and event time equal to their observed
time as <span class="math inline">\(T_i^* = 0.319 &lt; s_l +
\infty\)</span> for all landmark times.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">data_lm_w2</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## 'data.frame':    21543 obs. of  11 variables:</span></span>
<span><span class="co">##  $ id           : Factor w/ 1000 levels "1","2","3","4",..: 1 1 1 1 1 1 1 1 1 1 ...</span></span>
<span><span class="co">##  $ T            : num  0.319 0.319 0.319 0.319 0.319 ...</span></span>
<span><span class="co">##  $ E            : num  1 1 1 1 1 1 1 1 1 1 ...</span></span>
<span><span class="co">##  $ s            : num  0 0.02 0.04 0.06 0.08 0.1 0.12 0.14 0.16 0.18 ...</span></span>
<span><span class="co">##  $ w_s          : num  Inf Inf Inf Inf Inf ...</span></span>
<span><span class="co">##  $ event_time_lm: num  0.319 0.319 0.319 0.319 0.319 ...</span></span>
<span><span class="co">##  $ event_lm     : num  1 1 1 1 1 1 1 1 1 1 ...</span></span>
<span><span class="co">##  $ tind         : 'AsIs' num [1:21543, 1:99] 0 0 0 0 0 0 0 0 0 0 ...</span></span>
<span><span class="co">##   ..- attr(*, "dimnames")=List of 2</span></span>
<span><span class="co">##   .. ..$ : chr [1:21543] "1" "1" "1" "1" ...</span></span>
<span><span class="co">##   .. ..$ : chr [1:99] "1" "2" "3" "4" ...</span></span>
<span><span class="co">##  $ Z            : 'AsIs' num [1:21543, 1:99] 0.957 0.957 0.957 0.957 0.957 ...</span></span>
<span><span class="co">##   ..- attr(*, "dimnames")=List of 2</span></span>
<span><span class="co">##   .. ..$ : chr [1:21543] "1" "1" "1" "1" ...</span></span>
<span><span class="co">##   .. ..$ : chr [1:99] "1" "2" "3" "4" ...</span></span>
<span><span class="co">##  $ smat         : 'AsIs' num [1:21543, 1:99] 0 0.02 0.04 0.06 0.08 0.1 0.12 0.14 0.16 0.18 ...</span></span>
<span><span class="co">##  $ Z_int_cn     : 'AsIs' num [1:21543, 1:99] 0.00928 0.00941 0.00949 0.00972 0.0098 ...</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="fitting-the-model">Fitting the model<a class="anchor" aria-label="anchor" href="#fitting-the-model"></a>
</h3>
<p>Having set up the landmark datasets, the model is estimated easily
using the <strong>mgcv</strong> package. Estimation for both landmark
models is extremely fast.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># fit landmark model with w=0.02</span></span>
<span><span class="va">st_time_lm_w1</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">fit_lm_w1</span> <span class="op">&lt;-</span> <span class="fu">gam</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">event_time_lm</span>, <span class="va">s</span><span class="op">)</span> <span class="op">~</span> <span class="fu">s</span><span class="op">(</span><span class="va">tind</span>, <span class="va">smat</span>, by<span class="op">=</span><span class="va">Z_int_cn</span><span class="op">)</span>, family<span class="op">=</span><span class="va">cox.ph</span>, weights<span class="op">=</span><span class="va">event_lm</span>, data<span class="op">=</span><span class="va">data_lm_w1</span><span class="op">)</span></span>
<span><span class="op">(</span><span class="va">fit_time_lm_w1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/difftime.html" class="external-link">difftime</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span>, <span class="va">st_time_lm_w1</span>, units<span class="op">=</span><span class="st">"mins"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Time difference of 0.09381125 mins</span></span></code></pre>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># fit landmark model with w=infinity</span></span>
<span><span class="va">st_time_lm_w2</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">fit_lm_w2</span> <span class="op">&lt;-</span> <span class="fu">gam</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">event_time_lm</span>, <span class="va">s</span><span class="op">)</span> <span class="op">~</span> <span class="fu">s</span><span class="op">(</span><span class="va">tind</span>, <span class="va">smat</span>, by<span class="op">=</span><span class="va">Z_int_cn</span><span class="op">)</span>, family<span class="op">=</span><span class="va">cox.ph</span>, weights<span class="op">=</span><span class="va">event_lm</span>, data<span class="op">=</span><span class="va">data_lm_w2</span><span class="op">)</span></span>
<span><span class="op">(</span><span class="va">fit_time_lm_w2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/difftime.html" class="external-link">difftime</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span>, <span class="va">st_time_lm_w2</span>, units<span class="op">=</span><span class="st">"mins"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Time difference of 0.09542605 mins</span></span></code></pre>
</div>
</div>
<div class="section level2">
<h2 id="lm-hfcm-working-with-the-fitted-obejct">LM-HFCM: Working with the fitted obejct<a class="anchor" aria-label="anchor" href="#lm-hfcm-working-with-the-fitted-obejct"></a>
</h2>
<div class="section level3">
<h3 id="extracting-hatgammaus">Extracting <span class="math inline">\(\hat{\gamma}(u,s)\)</span><a class="anchor" aria-label="anchor" href="#extracting-hatgammaus"></a>
</h3>
<p>A key quantity of interest to extract from the fitted object is the
estimated functional coefficient, <span class="math inline">\(\hat{\gamma}(u,s)\)</span>. The code below shows
how to do this. To do so we need to first specify a grid of <span class="math inline">\((u,s)\)</span>, <span class="math inline">\(u &lt;
s\)</span> we wish to obtain estimates for. Here we use an evenly spaced
grid of length 100 on <span class="math inline">\([0,\text{max}(\mathbf{s})]\)</span>.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nupred_coef</span> <span class="op">&lt;-</span> <span class="fl">100</span></span>
<span><span class="va">nspred_coef</span> <span class="op">&lt;-</span> <span class="fl">100</span></span>
<span><span class="va">upred_coef</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="va">tmin</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">S</span><span class="op">)</span>, len<span class="op">=</span><span class="va">nupred_coef</span><span class="op">)</span></span>
<span><span class="va">spred_coef</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">S</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">S</span><span class="op">)</span>, len<span class="op">=</span><span class="va">nspred_coef</span><span class="op">)</span></span>
<span><span class="co">## get estimated coefficient</span></span>
<span><span class="co"># to get the estimated coefficients, need to evaluate the coefficient using predict.gam with type="terms"</span></span>
<span><span class="va">df_pred_lm_coef</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>tind <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">upred_coef</span>, <span class="va">nspred_coef</span><span class="op">)</span>,</span>
<span>                              smat <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">spred_coef</span>, each<span class="op">=</span><span class="va">nupred_coef</span><span class="op">)</span>,</span>
<span>                              Z_int_cn <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">df_pred_lm_coef</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">df_pred_lm_coef</span>, <span class="va">tind</span> <span class="op">&lt;</span> <span class="va">smat</span><span class="op">)</span></span>
<span><span class="va">gamma_hat_lm_w1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">fit_lm_w1</span>, newdata<span class="op">=</span><span class="va">df_pred_lm_coef</span>, type<span class="op">=</span><span class="st">"terms"</span><span class="op">)</span></span>
<span><span class="va">gamma_hat_lm_w2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">fit_lm_w2</span>, newdata<span class="op">=</span><span class="va">df_pred_lm_coef</span>, type<span class="op">=</span><span class="st">"terms"</span><span class="op">)</span></span>
<span><span class="co">## combine results into a single data frame for plotting</span></span>
<span><span class="va">df_pred_lm_coef</span><span class="op">$</span><span class="va">gamma_hat_w1</span> <span class="op">&lt;-</span> <span class="va">gamma_hat_lm_w1</span><span class="op">[</span>,<span class="st">"s(tind,smat):Z_int_cn"</span><span class="op">]</span></span>
<span><span class="va">df_pred_lm_coef</span><span class="op">$</span><span class="va">gamma_hat_w2</span> <span class="op">&lt;-</span> <span class="va">gamma_hat_lm_w2</span><span class="op">[</span>,<span class="st">"s(tind,smat):Z_int_cn"</span><span class="op">]</span></span></code></pre></div>
<p>The code below plots the true function along with the landmark model
estimates. We can see that, as expected, the landmark model with <span class="math inline">\(w=0.04\)</span> estimates the truth much more
closely than the model with <span class="math inline">\(w=\infty\)</span> due to bias associated with the
long prediction window.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## add in the true coefficient value</span></span>
<span><span class="va">df_pred_lm_coef</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">df_pred_lm_coef</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>gamma_true <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Trig.html" class="external-link">cos</a></span><span class="op">(</span><span class="fl">2</span> <span class="op">*</span> <span class="va">pi</span> <span class="op">*</span> <span class="op">(</span><span class="va">smat</span><span class="op">-</span><span class="va">tind</span><span class="op">)</span> <span class="op">/</span> <span class="fl">0.5</span><span class="op">)</span>  <span class="op">*</span> <span class="fl">10</span><span class="op">)</span> </span>
<span><span class="co">## plot the results</span></span>
<span><span class="co"># transform to long format for faceting then plot</span></span>
<span><span class="va">df_pred_lm_coef</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">pivot_longer</span><span class="op">(</span>cols<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"gamma_hat_w1"</span>,<span class="st">"gamma_hat_w2"</span>,<span class="st">"gamma_true"</span><span class="op">)</span>, </span>
<span>               names_to <span class="op">=</span> <span class="st">"result"</span>, values_to<span class="op">=</span><span class="st">"gamma_hat"</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>result <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">result</span>, levels<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"gamma_true"</span>,<span class="st">"gamma_hat_w1"</span>,<span class="st">"gamma_hat_w2"</span><span class="op">)</span>,</span>
<span>                         labels<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Truth"</span>,<span class="st">"Estimate w=0.04"</span>,<span class="st">"Estimate w=Infinity"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_raster</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">tind</span>,y<span class="op">=</span><span class="va">smat</span>,fill<span class="op">=</span><span class="va">gamma_hat</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu">facet_grid</span><span class="op">(</span><span class="op">~</span><span class="va">result</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">scale_fill_gradientn</span><span class="op">(</span>colours<span class="op">=</span><span class="fu">fields</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/fields/man/tim.colors.html" class="external-link">tim.colors</a></span><span class="op">(</span><span class="fl">50</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu">theme_classic</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu">xlab</span><span class="op">(</span><span class="st">"Historical Time (u)"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">ylab</span><span class="op">(</span><span class="st">"Landmark Time (s)"</span><span class="op">)</span></span></code></pre></div>
<p><img src="lm_hflm_estimation_prediction_files/figure-html/plot_estimated_coefficients-1.png" width="1440"></p>
</div>
<div class="section level3">
<h3 id="dynamic-predictions-for-survival-curves">Dynamic predictions for survival curves<a class="anchor" aria-label="anchor" href="#dynamic-predictions-for-survival-curves"></a>
</h3>
<p>In addition to extracting the estimated shape of the functional
coefficient, dynamic predictions of survival probabilities are often of
interest and a key focus of the methodology.</p>
<p>Dynamic predictions obtained from the landmark historical functional
Cox model are dependent on the landmark times (<span class="math inline">\(\mathbf{s}\)</span>) window lengths, <span class="math inline">\(\mathbf{w}=\{w_1,\ldots,w_L\}\)</span>, and how
far into the future dynamic predictions are made. If one is only
interested in making dynamic predictions within a landmark
time/prediciton window combination (i.e., for <span class="math inline">\(s_l &lt; t^* \leq s_l + w_l\)</span>), refereed
hereafter as “within window” predictions, then</p>
<p><span class="math display">\[\hat{S}(t^*|X_i, Z_i^{\mathcal{H}}(s_l))
= \text{exp}\left\{-e^{X\hat{\beta}(s_l) + \int_{0}^{s_l}
Z(u)\hat{\gamma}(u,s_l)du} \int_{s_l}^{t^*} \hat{\lambda}_0(t|s_l)dt
\right\}\;,\]</span></p>
<p>where <span class="math inline">\(\hat{\beta}\)</span> and <span class="math inline">\(\hat{\gamma}\)</span> are estimates from the model
fit and <span class="math inline">\(\int_{s_l}^{t^*}
\hat{\lambda}_0(t|s_l)dt\)</span> is an estimate of the cumulative
baseline hazard. We first show how to obtain these predictions from the
fitted object for both of our example landmark models and then move on
to describe how to make dynamic predictions for <span class="math inline">\(t^* &gt; s_l + w_l\)</span>. dNote that for our
second landmark model with <span class="math inline">\(w=\infty\)</span>, dynamic predictions can me made
for all <span class="math inline">\(t^*\)</span> using the formula
above.</p>
<div class="section level4">
<h4 id="within-window-dynamic-predictions">Within window dynamic predictions<a class="anchor" aria-label="anchor" href="#within-window-dynamic-predictions"></a>
</h4>
<p>There are multiple ways to extract within-window dynamic predictions
using Cox regression models estimated via the <em>mgcv</em> package.
Here we will show several methods. The first step in any approach is to
set up the data frame which will be supplied to the
<strong>predict.gam</strong> function.</p>
<p>For simplicity we start by considering a single landmark time, <span class="math inline">\(s_3 = 0.04\)</span>. Suppose we wish to make
predictions for a set of <span class="math inline">\(\mathbf{t}^* =
\{t_1^*, \ldots, t_Q^*\}\)</span> such that <span class="math inline">\(s_3 &lt; t^* &lt; s_3 + w_3\)</span> <span class="math inline">\(\forall t \in \mathbf{t}^*\)</span> with <span class="math inline">\(w_3 = 0.02\)</span> (landmark model 1). The data
should contain one row per participant with <span class="math inline">\(T_i &gt; s_3\)</span> per element of <span class="math inline">\(\mathbf{t}^*\)</span>. In our example, the number
of individuals in the risk set at <span class="math inline">\(s_3\)</span> is <span class="math inline">\(|R(s_3)| = |R(0.04)| = 950\)</span> (see code
below). And suppose we wish to make predictions on a fine grid in <span class="math inline">\((s_3,s_3 + w_3)\)</span> to plot individual
survival curves. Recall that the model uses stratified Cox regression,
allowing each landmark to have a landmark-specific baseline hazard
estimate, estimated using the Breslow estimator, a step function. As
such, the survival curves only change for <span class="math inline">\(t^* \in \{T_i : d_i = 1, 1 \leq i \leq N
\}\)</span>.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## get a data frame with one row per participant from the original data</span></span>
<span><span class="va">hfcm_sim_data_surv</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">hfcm_sim_data</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">id</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">slice</span><span class="op">(</span><span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">ungroup</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">## how many participants have an event or are censored beyond s_3</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">hfcm_sim_data_surv</span><span class="op">$</span><span class="cn">T</span> <span class="op">&gt;</span> <span class="va">S</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span> <span class="co">## 950</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 950</span></span></code></pre>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## set grid of points to obtain predictions on</span></span>
<span><span class="va">t_star</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="va">S</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, <span class="va">S</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span> <span class="op">+</span> <span class="va">W1</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, len<span class="op">=</span><span class="fl">50</span><span class="op">)</span></span></code></pre></div>
<p>Returning to the software implementation to get dynamic predictions,
we need to create a data frame where each row contains the components
required for model fitting associated with <span class="math inline">\(Z_i^{\mathcal{H}}(s_3)\)</span> for all <span class="math inline">\(i \in R(s_3)\)</span>, as well as the landmark
information and prediction time. Luckily, for this simple case, the data
object returned by the <strong>make_lm_data</strong> function can be
used here as it contains all the components the model required to obtain
predictions with the exception of the prediction times of interest. We
create the desired data frame by subsetting the data object returned by
the <strong>make_lm_data</strong> to those participants in <span class="math inline">\(R(s_3)\)</span>, creating a separate data frame
with all combinations of <span class="math inline">\(i\)</span> and
<span class="math inline">\(\mathbf{t}^*\)</span>, left joining the data
frames, then filtering out <span class="math inline">\(t \notin
\mathbf{t}^*\)</span>. The code below sets up this data frame.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## get s_3 data</span></span>
<span><span class="va">data_lm_S3</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">data_lm_w1</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="co">## filter to just landmark time of interest</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">s</span> <span class="op">==</span> <span class="va">S</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">## create data frame with all unique combinations of:</span></span>
<span><span class="co">##  each id in the risk set and prediction time of interest</span></span>
<span><span class="va">df_t_star_s_3</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html" class="external-link">expand.grid</a></span><span class="op">(</span>id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">data_lm_S3</span><span class="op">$</span><span class="va">id</span><span class="op">)</span>,</span>
<span>              event_time_lm <span class="op">=</span> <span class="va">t_star</span><span class="op">)</span></span>
<span></span>
<span><span class="va">data_lm_S3_pred</span> <span class="op">&lt;-</span></span>
<span>  <span class="co">## left join the data frames</span></span>
<span>  <span class="fu">left_join</span><span class="op">(</span><span class="va">df_t_star_s_3</span>, </span>
<span>            <span class="co">## drop observed event times in the data, unneeded for prediction</span></span>
<span>            <span class="co">## this functionally filters out prediction times not of interest</span></span>
<span>            <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">data_lm_S3</span>, <span class="op">-</span><span class="va">event_time_lm</span><span class="op">)</span>, by<span class="op">=</span><span class="st">"id"</span><span class="op">)</span> </span></code></pre></div>
<p>Having set up the data frame, obtaining survival curves is as simple
as making a call to <strong>predict.gam</strong> with the argument
type=“response” (indicating predictions on the response scale, or
survival probability). We then merge those predictions back with
participant ids and event times for plotting</p>
<p>The code below plots survival curve estimates for the first 12
participant ids</p>
<p>This same idea can be applied to get within window predictions,
conditional survival probability predictions for every landmark time at
once by considering all combinations of landmark times, prediction
windows, participant ids, prediction times, and observed event times.
Then merge that data with the landmark data set. Unfortunately this will
tend to create a very large data frame that may exceed RAM limits for
many common work environments. Here, we bypass this issue by only
looking making predictions for the first 25 participant id’s. This
procedure could be split by participant id, landmark time, or any split
desired by the user depending on their purpose and computational
limitations..</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## create data frame with all unique combinations of:</span></span>
<span><span class="co">##  each id in the risk set and prediction time of interest</span></span>
<span><span class="co">## all observed event times and a sequence of points on the range of T</span></span>
<span><span class="va">t_star_all</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">hfcm_sim_data</span><span class="op">$</span><span class="cn">T</span><span class="op">[</span><span class="va">hfcm_sim_data</span><span class="op">$</span><span class="va">E</span><span class="op">==</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>, </span>
<span>                             <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span>,len<span class="op">=</span><span class="fl">100</span><span class="op">)</span><span class="op">)</span> </span>
<span>                           <span class="op">)</span></span>
<span>                   <span class="op">)</span></span>
<span><span class="va">data_lm_all_pred</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html" class="external-link">expand.grid</a></span><span class="op">(</span>id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">hfcm_sim_data</span><span class="op">$</span><span class="va">id</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">25</span><span class="op">]</span>,</span>
<span>              s <span class="op">=</span> <span class="va">S</span>,</span>
<span>              event_time_lm <span class="op">=</span> <span class="va">t_star_all</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="co">## join with survival data, filter to times before observed events</span></span>
<span>  <span class="fu">left_join</span><span class="op">(</span><span class="va">hfcm_sim_data_surv</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">s</span> <span class="op">&lt;</span> <span class="cn">T</span>, <span class="va">event_time_lm</span> <span class="op">&gt;=</span> <span class="va">s</span>, <span class="va">event_time_lm</span> <span class="op">&lt;=</span> <span class="va">s</span> <span class="op">+</span> <span class="fl">0.02</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="co">## get just variables of interest</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">id</span>, <span class="va">s</span>, <span class="va">event_time_lm</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="co">## convert variable type for merging</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">id</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="co">## join with landmark dataset</span></span>
<span>  <span class="fu">left_join</span><span class="op">(</span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">data_lm_w1</span> , <span class="op">-</span><span class="va">event_time_lm</span><span class="op">)</span>, by<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"id"</span>,<span class="st">"s"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Joining with `by = join_by(id)`</span></span></code></pre>
<p>Then we get predictions in the exact same way as before</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">surv_preds_all</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu">predict.gam</span><span class="op">(</span><span class="va">fit_lm_w1</span>, newdata<span class="op">=</span><span class="va">data_lm_all_pred</span>, type<span class="op">=</span><span class="st">'response'</span><span class="op">)</span></span>
<span><span class="co">## combine with prediction data frame for plotting (participant IDs with event times and predictions)</span></span>
<span><span class="va">surv_preds_all</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">data_lm_all_pred</span>, <span class="va">id</span>, <span class="va">event_time_lm</span>, <span class="va">s</span><span class="op">)</span>, <span class="st">"S_hat"</span> <span class="op">=</span> <span class="va">surv_preds_all</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">surv_preds_all</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## 'data.frame':    5159 obs. of  4 variables:</span></span>
<span><span class="co">##  $ id           : Factor w/ 1000 levels "1","2","3","4",..: 1 2 3 4 5 6 7 8 9 10 ...</span></span>
<span><span class="co">##  $ event_time_lm: num  0 0 0 0 0 0 0 0 0 0 ...</span></span>
<span><span class="co">##  $ s            : num  0 0 0 0 0 0 0 0 0 0 ...</span></span>
<span><span class="co">##  $ S_hat        : num  1 1 1 1 1 1 1 1 1 1 ...</span></span></code></pre>
<p>We can now plot the landmark-specific conditional probability of
survival for each participant id. In the plot below each panel
represents a participant, with color indicating landmark time. A few
things are worth noting. First, the scale is hard to see due to
differential predicted survival probabilities for participant id 13 and
19 for later landmark times. Additionally, note the fact that the
survival probabilities are not non-increasing. This is because these are
conditional probabilties and are thus “reset” at 1 for each landmark
time. Further, note that survival predictions are not available over the
entire follow-up for all individuals. This is a result of their being
censored or experiencing the event. In the absence of longitudinal data,
predictions beyond <span class="math inline">\(\text{max_{s \in
\mathbf{s}}(s: s &lt; T_i)}\)</span> require dynamic prediction of the
longitudinal predictor (a topic for a future vignette).</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">surv_preds_all</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>s <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">s</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">event_time_lm</span>, y<span class="op">=</span><span class="va">S_hat</span>, color<span class="op">=</span><span class="va">s</span>, group<span class="op">=</span><span class="va">s</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">facet_wrap</span><span class="op">(</span><span class="op">~</span><span class="va">id</span>, ncol<span class="op">=</span><span class="fl">5</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu">ylab</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/expression.html" class="external-link">expression</a></span><span class="op">(</span><span class="fu">Pr</span><span class="op">(</span><span class="cn">T</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&gt;</span> <span class="va">t</span><span class="op">~</span><span class="st">"|"</span> <span class="op">~</span> <span class="cn">T</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&gt;</span> <span class="va">s</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">xlab</span><span class="op">(</span><span class="st">"Event time (t)"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_classic</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="lm_hflm_estimation_prediction_files/figure-html/dynamic_prediction_plot_all-1.png" width="1440"></p>
<p>However, we can obtain complete predicted survival curves (at least
for fully observed data). The code below implements the method described
in the manuscript.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">surv_preds_all_comp</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">surv_preds_all</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">id</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">arrange</span><span class="op">(</span><span class="va">s</span>, <span class="va">event_time_lm</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>delta_s <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="cn">NA</span>,<span class="fu"><a href="https://rdrr.io/r/base/diff.html" class="external-link">diff</a></span><span class="op">(</span><span class="va">s</span><span class="op">)</span><span class="op">)</span>,</span>
<span>         S_hat_lag <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="va">S_hat</span><span class="op">[</span><span class="op">-</span><span class="fu">n</span><span class="op">(</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>,</span>
<span>         mult_fac <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">delta_s</span> <span class="op">!=</span> <span class="fl">0</span> <span class="op">&amp;</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">delta_s</span><span class="op">)</span>, <span class="va">S_hat_lag</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>         mult_fac <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html" class="external-link">cumprod</a></span><span class="op">(</span><span class="va">mult_fac</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">id</span>, <span class="va">s</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>mult_fac <span class="op">=</span> <span class="va">mult_fac</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,</span>
<span>         S_hat_full <span class="op">=</span> <span class="va">S_hat</span> <span class="op">*</span> <span class="va">mult_fac</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">ungroup</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">arrange</span><span class="op">(</span><span class="va">id</span>, <span class="va">s</span>, <span class="va">event_time_lm</span><span class="op">)</span> </span></code></pre></div>
<p>Then we can plot <span class="math inline">\(\hat{P}(T_i &gt;
t)\)</span> as before, with each panel representing a unique participant
identifier.</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">surv_preds_all_comp</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>s <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">s</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">event_time_lm</span>, y<span class="op">=</span><span class="va">S_hat_full</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">facet_wrap</span><span class="op">(</span><span class="op">~</span><span class="va">id</span>, ncol<span class="op">=</span><span class="fl">5</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu">ylab</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/expression.html" class="external-link">expression</a></span><span class="op">(</span><span class="fu">Pr</span><span class="op">(</span><span class="cn">T</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&gt;</span> <span class="va">t</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">xlab</span><span class="op">(</span><span class="st">"Event time (t)"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_classic</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="lm_hflm_estimation_prediction_files/figure-html/surv_curves_full_plot-1.png" width="1440"></p>
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Andrew Leroux.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.9.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
